<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Book Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel='stylesheet' href='/stylesheets/style.css' />
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    .navbar {
      margin-top: 0;
    }

    .card-img-top {
      background-color: #f8f9fa;
      height: 180px;
      object-fit: cover;
      cursor: pointer;
    }

    .search-card {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .book-card {
      transition: transform 0.2s;
    }

    .book-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .results-count {
      font-size: 0.9rem;
      color: #6c757d;
      margin-bottom: 15px;
    }

    .action-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">Online Library</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="/books">Books</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/search">Search</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item active" aria-current="page">Books</li>
      </ol>
    </nav>

    <!-- Search and Filter Card -->
    <div class="search-card">
      <form id="filterForm" method="GET" action="/books">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="keywords" class="form-label">Search</label>
            <input type="text" class="form-control" id="keywords" name="keywords" 
                  placeholder="Title, author, isbn" 
                  value="<%= searchParams.keywords || '' %>">
          </div>
          
          <div class="col-md-3">
            <label for="category" class="form-label">Category</label>
            <select class="form-select" id="category" name="category">
              <option value="">All Categories</option>
              <% categories.forEach(category => { %>
                <option value="<%= category %>" <%= searchParams.category === category ? 'selected' : '' %>>
                  <%= category %>
                </option>
              <% }); %>
            </select>
          </div>
          
          <div class="col-md-3 d-flex align-items-end">
            <button type="submit" class="btn btn-primary me-2">Filter</button>
            <a href="/books" class="btn btn-outline-secondary">Reset</a>
          </div>
        </div>
      </form>
    </div>

    <!-- Action Bar with Add Button and Results Count -->
    <div class="action-bar">
      <% if (bookings.length > 0) { %>
        <div class="results-count">
          Showing <%= (pagination.currentPage - 1) * pagination.perPage + 1 %> - 
          <%= Math.min(pagination.currentPage * pagination.perPage, pagination.totalBooks) %> 
          of <%= pagination.totalBooks %> books
        </div>
      <% } %>
      <a href="/book/add" class="btn btn-primary">Add New Book</a>
    </div>

    <!-- Cards -->
    <% if (bookings.length === 0) { %>
      <div class="text-center py-5">
        <h4>No books found</h4>
        <p class="text-muted">Try adjusting your search filters or add a new book</p>
      </div>
    <% } else { %>
      <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
        <% bookings.forEach(book=> { %>
          <div class="col">
            <div class="card h-100 book-card">
              <% if(book.coverImage && book.coverImage.startsWith('data:image')) { %>
                <img src="<%= book.coverImage %>" class="card-img-top" 
                     alt="<%= book.title %>"
                     onclick="window.location.href='/book/detail/<%= book._id %>'">
              <% } else if(book.coverImage) { %>
                <img src="<%= book.coverImage %>" class="card-img-top" 
                     alt="<%= book.title %>"
                     onerror="this.src='https://picsum.photos/id/237/300/180'"
                     onclick="window.location.href='/book/detail/<%= book._id %>'">
              <% } else { %>
                <img src="https://picsum.photos/id/237/300/180" class="card-img-top" 
                     alt="<%= book.title %>"
                     onclick="window.location.href='/book/detail/<%= book._id %>'">
              <% } %>
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">
                  <%= book.title %>
                </h5>
                <p class="card-text text-muted mb-1">
                  <small>by <%= book.author %></small>
                </p>
                <% if (book.description) { %>
                  <p class="card-text">
                    <%= book.description.length > 100 ? book.description.substring(0, 100) + '...' : book.description %>
                  </p>
                <% } %>

                <div class="mt-auto">
                  <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                      <% if (book.updatedAt) { %>
                        Last updated <%= timeSince(new Date(book.updatedAt)) %>
                      <% } %>
                    </small>
                    <a href="/book/edit/<%= book._id %>" class="btn btn-outline-primary btn-sm">Edit</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% }); %>
      </div>
    <% } %>

    <!-- Pagination -->
    <% if (bookings.length > 0) { %>
      <nav aria-label="Page navigation" class="my-4">
        <ul class="pagination justify-content-center">
          <% if (pagination.currentPage > 1) { %>
            <li class="page-item">
              <a class="page-link" 
                 href="<%= buildPaginationUrl(pagination.currentPage - 1) %>">Previous</a>
            </li>
          <% } else { %>
            <li class="page-item disabled">
              <a class="page-link">Previous</a>
            </li>
          <% } %>

          <% for (let i = 1; i <= pagination.totalPages; i++) { %>
            <li class="page-item <%= i === pagination.currentPage ? 'active' : '' %>">
              <a class="page-link" href="<%= buildPaginationUrl(i) %>"><%= i %></a>
            </li>
          <% } %>

          <% if (pagination.currentPage < pagination.totalPages) { %>
            <li class="page-item">
              <a class="page-link" 
                 href="<%= buildPaginationUrl(pagination.currentPage + 1) %>">Next</a>
            </li>
          <% } else { %>
            <li class="page-item disabled">
              <a class="page-link">Next</a>
            </li>
          <% } %>
        </ul>
      </nav>
    <% } %>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Time formatting helper function
    function timeSince(date) {
      const seconds = Math.floor((new Date() - date) / 1000);

      let interval = Math.floor(seconds / 31536000);
      if (interval >= 1) return interval + " year" + (interval === 1 ? "" : "s") + " ago";

      interval = Math.floor(seconds / 2592000);
      if (interval >= 1) return interval + " month" + (interval === 1 ? "" : "s") + " ago";

      interval = Math.floor(seconds / 86400);
      if (interval >= 1) return interval + " day" + (interval === 1 ? "" : "s") + " ago";

      interval = Math.floor(seconds / 3600);
      if (interval >= 1) return interval + " hour" + (interval === 1 ? "" : "s") + " ago";

      interval = Math.floor(seconds / 60);
      if (interval >= 1) return interval + " minute" + (interval === 1 ? "" : "s") + " ago";

      return "just now";
    }
  </script>
</body>
</html>